{% extends "map_base.html" %}
    {% block mapjsscript %}
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&callback;=initialize"></script>
    <script src="/static/js/markerclusterer_google.js" type="text/javascript"></script>
    {% end %}
    <script type="text/javascript">
    {% block jsscript %}
      var map;
      var polyline;
      var _fixes = [];
      var _ts = [];
      var _markers = [];
      var mc = null;

      function initMap() {
        var clientloc = google.loader.ClientLocation;
        if (!clientloc) {
            clientloc = {latitude: 39.9100, longitude: 116.4000};
        }
        var myOptions = {
          zoom: 13,
          center: (_fixes.length > 0) ? _fixes[0] : (new google.maps.LatLng(clientloc.latitude, clientloc.longitude)),
          scaleControl: true,
          overviewMapControl: true,
          overviewMapControlOptions: {opened: true},
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(document.getElementById("map_canvas"),
                                                          myOptions);
        var mcOptions = {maxZoom: 20,
                         averangeCenter: true};
        mc = new MarkerClusterer(map, [], mcOptions);
      }

      function show_point(lat, lon, sigma, markertime) {
        if (polyline) {
          polyline.setMap(null);
        }
        for (i in _markers) {
          _markers[i].setMap(null);
        }
        _markers.length = 0;

        var fix = new google.maps.LatLng(lat, lon);
        var markerPoint = new google.maps.Marker({
                            position: fix,
                            title: "Current Fix",
                            map: map});
        _markers.push(markerPoint);
        fn_clickMarker(markerPoint, markertime);

        var circle = new google.maps.Circle({
                      map: map,
                      radius: sigma,
                      fillColor: '#AA0000',
                      fillOpacity: 0.5,
                      strokeOpacity: 0.6,
                      strokeWeight: 1,
                      strokeColor: "red"});
        circle.bindTo('center', markerPoint, 'position');
        _markers.push(circle);

        map.setCenter(fix);
      }

      function fn_drawLine() {
        if (polyline) {
          polyline.setMap(null);
        }
        polyline = new google.maps.Polyline({
           path: _fixes,
           strokeColor: "#FF0000",
           strokeOpacity: 0.5,
           strokeWeight: 3});

        polyline.setMap(map);
      }

      var infowindow = new google.maps.InfoWindow();
      function fn_clickMarker(mPoint, tempDate) {
        google.maps.event.addListener(mPoint, "click", function() {
          var geocoder = new google.maps.Geocoder();
          //TODO: cache in title
          geocoder.geocode({"latLng": mPoint.getPosition()}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              if (results[0]) {
                var str = mPoint.getTitle()
                  +"<ul><li>Address: "+results[0].formatted_address+"</li>"
                  +"<li>Lon: "+mPoint.getPosition().lng()+"</li>"
                  +"<li>Lat: "+mPoint.getPosition().lat()+"</li>"
                  +"<li>Time: "+tempDate+"</li></ul>";
                infowindow.setContent(str);
                infowindow.open(map, mPoint);
              }
            } else {
              alert("Geocode error: " + status);
            }
          });
        });
      }

      function fn_locusConfirm() {
        var tempDate = $("#locusDate").val().replace(/-/g, "");
        var str_begin = $("#locusBeginSlider").val().replace(/:/g, "") + "00";
        var str_end = $("#locusEndSlider").val().replace(/:/g, "") + "00";
        var str_locusDate = "/track/".concat(tempDate, str_begin) + "/".concat(tempDate, str_end);

        $.get(str_locusDate, "", function(data) {
          var fixes = data.fixes;
          _fixes = [];
          mc.clearMarkers();
          $("#fixnum").text(fixes.length);
          if (_markers) {
            for (i in _markers) {
              _markers[i].setMap(null);
            }
            _markers.length = 0;
          }

          if (fixes.length > 0) {
            for (var i in fixes) {
              _fixes[i] = new google.maps.LatLng(fixes[i][1], fixes[i][2]);
              var markerPoint = new google.maps.Marker({
                       position: _fixes[i],
                       title: "Point " + i,
                       map: map});
              _markers.push(markerPoint);
              fn_clickMarker(markerPoint, fixes[i][8]);
            }
            mc.addMarkers(_markers);
            map.setCenter(_fixes[0]);
          }
          fn_drawLine();
        }, "json");
     }
{% end %}
