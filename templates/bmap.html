<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>DBJ GPS Testbed</title>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script>
    <script type="text/javascript" src="http://dev.baidu.com/wiki/static/map/API/examples/script/changeMore.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
    <link type="text/css" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" rel="stylesheet" />
    <style type="text/css">
	body {
		margin: 3;
		padding: 0 0 20px;
		min-height: 100%;
		/* font-family: "Lucida Grande", "Arial", "Helvetica", "Verdana", "sans-serif"; */
		font-family: "Arial", "Helvetica", "Verdana", "sans-serif";
		font-size: 10px;
	}

    #locusSlider {
        margin: 7 10 0 10;
        width: 300px; 
        float: left;
    }
    </style>
    <script type="text/javascript">
      var map;
      var polyline;
      var _fixes = new Array();
      var _ts = new Array();

      {% for fix in fixes %}
        _fixes.push(new BMap.Point({{fix[2]}}, {{fix[1]}}));
        _ts.push("{{fix[3]}}");
      {% end %}

      //initMap()函数，将地图程序加入页面
      function initMap() {
          map = new BMap.Map("map_canvas"); // 创建地图实例
          map.centerAndZoom(new BMap.Point(116.36343, 40.0045), 15);
          map.enableScrollWheelZoom();
          //map.addControl(new BMap.NavigationControl());
          map.addControl(new BMap.ScaleControl());
          var overvierOption = new BMap.OverviewMapControl();
          overvierOption.isOpen = true;
          map.addControl(new BMap.OverviewMapControl(overvierOption));
          var opts = {anchor: BMAP_ANCHOR_TOP_LEFT,
                      offset: new BMap.Size(10, 10)};
          map.addControl(new BMap.NavigationControl(opts));

          BMap.Convertor.transMore(_fixes, 0, callback);

          var $locusElement = $("#locusDate");
          $locusElement.datepicker();
          $locusElement.datepicker("setDate", new Date());
          $locusElement.datepicker("option", "dateFormat", "yy-mm-dd");
          fn_initSlider();
      }

      function fn_drawLine() {
        polyline = new BMap.Polyline(_fixes, 
                                     {strokeColor:"red", 
                                      strokeWeight:6, 
                                      strokeOpacity:0.5});
        map.addOverlay(polyline);
      }

      var gc = new BMap.Geocoder();    
      function fn_clickMarker(marker, tempDate) {
        marker.addEventListener("click", function(e){ 
          gc.getLocation(e.point, function(rs){
              var s = marker.getTitle()
                  +"<ul><li>Address: "+rs.address+"</li>"
                  +"<li>Lng: "+rs.point.lng+"</li>"
                  +"<li>Lat: "+rs.point.lat+"</li>"
                  +"<li>Time: "+tempDate+"</li></ul>";
            marker.openInfoWindow(new BMap.InfoWindow(s));
          });
        });
      }

      function fn_locusConfirm() {
        var tempDate = $("#locusDate").val().replace(/-/g, "");
        var str_begin = $("#locusBeginSlider").val().replace(/:/g, "") + "00";
        var str_end = $("#locusEndSlider").val().replace(/:/g, "") + "00";
        var str_locusDate = "/track/".concat(tempDate, str_begin) + "/".concat(tempDate, str_end);

        $.get(str_locusDate, "", function(data) {
          var fixes = data.fixes;
          _fixes = [];
          _ts = [];
          map.clearOverlays();

          if (fixes.length > 0) {
            for (var i in fixes) {
              _fixes[i] = new BMap.Point(fixes[i][2], fixes[i][1]);
              _ts[i] = fixes[i][3];
            }
            BMap.Convertor.transMore(_fixes, 0, callback);
          }
        }, "json");
     }

     function callback(res){
       _fixes = [];
       for(var i in res) {
         if (res[i].error != 0) {
           continue;
         }
         var point = new BMap.Point(res[i].x, res[i].y);
         _fixes.push(point);
         var marker = new BMap.Marker(point, {title: "Point " + i});
         map.addOverlay(marker);
         fn_clickMarker(marker, _ts[i]);
       }
       map.centerAndZoom(_fixes[0], 15);
       fn_drawLine();
    }

     // 初始化slide
     function fn_initSlider() {
       $("#locusSlider").slider({
            min: 0,
            max: 1439,
            values: [420, 1140],
            range: true,
            slide: function (event, ui) {
                var str_slideVal1 = fn_slideValToTimeVal(ui.values[0]);
                var str_slideVal2 = fn_slideValToTimeVal(ui.values[1]);
                $("#locusBeginSlider").val(str_slideVal1);
                $("#locusEndSlider").val(str_slideVal2);
            }
        });

        // 页面没有滑动进进行初始化数据
        $("#locusBeginSlider").val("07:00");
        $("#locusEndSlider").val("19:00");
        $("#locusSlider").slider("option", "values", [420, 1140]);
    }

    // 通过slide滑块的值判断显示的时间点
    function fn_slideValToTimeVal(n_slideVal) {
      var n_hour = Math.floor(n_slideVal / 60);
      var n_minute = n_slideVal % 60;
      n_hour = n_hour < 10 ? "0"+ n_hour : n_hour;
      n_minute = n_minute < 10 ? "0"+ n_minute : n_minute;
      return n_hour + ":" + n_minute;
    }
    </script>
  </head>

  <body onload="initMap()">
    <h4>Current Mobile: {{mobile}} <a href="/logout" style="float: right;">Logout</a></h4>
    <hr>
    <div style="float: left">
    Date: <input type="text" id="locusDate" />
    Start: <input id="locusBeginSlider" type="text" />
    End: <input id="locusEndSlider" type="text" />
    </div>
    <div id="locusSlider" title="Slide to adjust the time slot."></div>
    <input type="button" value="Query" id="locusConfirm" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only ui-state-hover" onclick="fn_locusConfirm();"/>
    <hr>
    <div id="map_canvas" style="width: 100%; height: 90%"></div>
  </body>
</html>
